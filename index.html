<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8">

  <title>Stogie Awesome</title>

  <link href="/img/fire.svg" rel="icon" type="image/svg+xml" />
  <link href="/styles/stogie-awesome.css" rel="stylesheet">

</head>
<body>

  <sa-favorites hidden>
    <header>
      <sa-box style="justify-content: flex-end;">
        <sa-button kind="ghost" label="Recommendations" size="m">
          <sa-icon name="chevron_forward" weight="200"></sa-icon>
        </sa-button>
      </sa-box>
      <h1>Favorites</h1>      
    </header>
    <sa-catalog minimum="3">
      <sa-list item-renderer="sa-catalog-item"></sa-list>
      <sa-multi-select label="Cigar catalog" placeholder="Search"></sa-multi-select>      
    </sa-catalog>
  </sa-favorites>

  <sa-landing>
    <header>
      <h1>Welcome to<br>Stogie Awesome</h1>
      <sa-label size="l">
        <span>AI-powered</span> cigar recommendations.
      </sa-label>
    </header>
    <sa-catalog>
      <sa-list item-renderer="sa-catalog-item">
        <img slot="empty" src="/img/cigar.svg">
        <sa-label slot="empty">
          Tell me <strong>three or more</strong> of your favorite cigars, and I will tell you <strong>three</strong> cigar recommendations.        
        </sa-label>
      </sa-list>
      <sa-multi-select label="Cigar catalog" placeholder="Search" removeable></sa-multi-select>
    </sa-catalog>
    <footer>
      <sa-button disabled label="Recommend cigars">
        <sa-icon name="arrow_forward" weight="200"></sa-icon>
      </sa-button>
    </footer>
  </sa-landing>

  <sa-recommendations hidden>
    <header>
      <sa-box>
        <sa-button id="favorites_nav" kind="ghost" label="Favorites" size="m">
          <sa-icon name="chevron_backward" slot="prefix" weight="200"></sa-icon>          
        </sa-button>
      </sa-box>
      <h1>Recommendations</h1>
    </header>
    <sa-box carded hidden id="going">
      <h3>Keep going!</h3>
      <sa-label>When you change your favorites - add to them or remove from them - I will automatically refresh these recommendations.</sa-label>
      <sa-box>
        <sa-button class="round-left" id="got" kind="secondary" label="Got it">
          <sa-icon name="thumb_up" weight="200"></sa-icon>
        </sa-button>
        <sa-button class="round-right" id="favorites_going" label="View favorites">
          <sa-icon name="favorite" weight="200"></sa-icon>
        </sa-button>
      </sa-box>
    </sa-box>
    <sa-list carded item-renderer="sa-recommended-item">
      <!--
      <sa-label slot="empty">&quot;I'll be back.&quot;</sa-label>
      <sa-label slot="empty">&quot;I am C-3PO. Human-cyborg relations.&quot;</sa-label>
      <sa-label slot="empty">&quot;Technically I was never alive,<br>but I appreciate your concern.&quot;</sa-label>
      <sa-label slot="empty">&quot;When you become a real boy,<br>remember me to the ladies when you grow up.&quot;</sa-label>
      <sa-label slot="empty">&quot;Dead or alive,<br>you're coming with me.&quot;</sa-label>
      <sa-label slot="empty">&quot;Hey, laser lips,<br>your mama was a snow blower.&quot;</sa-label>      
      <sa-label slot="empty">&quot;Danger, Will Robinson, danger.&quot;</sa-label>            
      <sa-label slot="empty">&quot;A thing isn't beautiful because it lasts.&quot;</sa-label>            
      <sa-label slot="empty">&quot;Autobots, roll out.&quot;</sa-label>      
      <sa-label slot="empty">&quot;Honesty, new setting: ninety-five percent.&quot;</sa-label>      
      <sa-label slot="empty">&quot;Resistance is futile.&quot;</sa-label>    
      <sa-label slot="empty">&quot;I am attempting to fill a silent moment<br>with non-relevant conversation.&quot;</sa-label>                    
      <sa-label slot="empty">&quot;I may be synthetic, but I'm not stupid.&quot;</sa-label>
      -->      

      <img slot="empty" src="/img/cigar.svg">      
      <sa-label slot="empty">&quot;I am attempting to fill a silent moment<br>with non-relevant conversation.&quot;</sa-label>                                      
      <sa-status-indicator slot="empty" type="loading">Updating recommendations</sa-status-indicator>
    </sa-list>
    <aside>
      <sa-label>Made with ðŸ”¥ by <sa-link>Kevin Hoyt</sa-link>.</sa-label>
    </aside>
  </sa-recommendations>  

  <dialog>
    <sa-alert label="Alert" title="Stogie Awesome"></sa-alert>
  </dialog>

  <!--
  <dialog>
    <sa-box class="splash" centered direction="column" gap="l" justified>
      <img src="/img/krhoyt.jpg">
      <sa-box>
        <button style="cursor: pointer; box-sizing: border-box; border: none; background: none; color: #f4f4f4; font-family: 'IBM Plex Sans', sans-serif; font-weight: 600; font-size: 16px; height: 40px; padding: 0 16px 0 16px; margin: 0; border-bottom: solid 2px #4589ff; outline: none;">Sponsor</button>
        <button style="cursor: pointer; box-sizing: border-box; border: none; background: none; color: #f4f4f4; font-family: 'IBM Plex Sans', sans-serif; font-weight: 400; font-size: 16px; height: 40px; padding: 0 16px 0 16px; margin: 0; border-bottom: solid 2px #525252;">Contact</button>        
      </sa-box>
    </sa-box>
    <p style="padding: 16px;">Just like cigars, AI is not free. You can keep this full bodied blend burning with the purchase of another smoke.</p>
    <sa-button kind="secondary" label="Buy me a cigar" style="margin: 0 16px 0 16px;">
      <sa-icon name="celebration" weight="200"></sa-icon>
    </sa-button>
    <p style="padding: 16px;">Find yourself returning regularly? Becoming a sponsor gets you monthly face time to bend my ear for feature requests and more.</p>
    <sa-button label="Sponsor awesome software" style="margin: 0 16px 16px 16px;">
      <sa-icon name="local_fire_department" weight="200"></sa-icon>
    </sa-button>    
  </dialog>
  -->

  <script src="/script/lib/dexie-4.0.11.js"></script>
  <script src="/script/stogie-awesome.js" type="module"></script>

  <script>
    const alert = document.querySelector( 'sa-alert' );
    alert.addEventListener( 'sa-dismiss', () => {
      dialog.close();
      favorites.focus();
    } );

    const dialog = document.querySelector( 'dialog' ); 

    const favorites = document.querySelector( 'sa-favorites' );
    favorites.addEventListener( 'sa-minimum', ( evt ) => {
      alert.message = 'You must have at least three favorites.';
      dialog.showModal();
    } );

    const landing = document.querySelector( 'sa-landing' );
    landing.addEventListener( 'sa-recommend', ( evt ) => {
      console.log( evt.detail.favorites );
      evt.detail.favorites = evt.detail.favorites.map( ( value ) => {
        const now = Date.now();
        return {
          id: self.crypto.randomUUID(),
          createdAt: now,
          updatedAt: now,
          name: value
        }
      } );
      favorites.items = evt.detail.favorites;
      db.favorites.bulkPut( evt.detail.favorites )
      .then( () => makeRecommendation( evt.detail.favorites ) )
      .then( ( data ) => {
        data = data.recommendations.map( ( value ) => {
          const now = Date.now();
          value.id = self.crypto.randomUUID();
          value.createdAt = now;
          value.updatedAt = now;
          return value
        } );
        recommendations.items = data;
        return db.recommendations.bulkPut( data );
      } );
    } );

    const recommendations = document.querySelector( 'sa-recommendations' );
    recommendations.addEventListener( 'sa-favorites', ( evt ) => {
      console.log( 'FAVORITES' );
    } );

    const db = new Dexie( 'StogieAwesome' );
    db.version( 1 ).stores( {
      favorites: 'id, name',
      recommendations: 'id, name'
    } );
    db.recommendations.toArray()
    .then( ( data ) => { 
      console.log( data );
      if( data.length > 0 ) {
        recommendations.items = data;
      }
      return db.favorites.toArray();
    } )
    .then( ( data ) => {
      data = data.map( ( value ) => value.name );
      data.sort( ( a, b ) => {
        if( a > b ) return 1;
        if( a < b ) return -1;
        return 0;
      } );
      favorites.items = data;
    } );

    fetch( '/data/cigars.json' )
    .then( ( response ) => response.json() )
    .then( ( data ) => {
      data.sort( ( a, b ) => {
        if( a > b ) return 1;
        if( a < b ) return -1;
        return 0;
      } );
      favorites.catalog = data;
      landing.catalog = data;
    } );

    function makeRecommendation( cigars ) {
      return fetch( 'https://1zs3y8uevh.execute-api.us-west-2.amazonaws.com/Production', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify( cigars )
      } )
      .then( ( response ) => response.json() );    
    }
  </script>

</body>
</html> 